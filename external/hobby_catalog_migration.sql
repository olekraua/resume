-- Split profile-specific hobbies into a catalog + join table.
-- Run manually on Postgres with a full backup.
-- Assumes an existing hobby table with columns: id, id_profile, name.

BEGIN;

ALTER TABLE hobby RENAME TO hobby_old;

CREATE TABLE hobby (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name varchar(30) NOT NULL UNIQUE
);

CREATE TABLE profile_hobby (
    id_profile bigint NOT NULL,
    id_hobby bigint NOT NULL,
    PRIMARY KEY (id_profile, id_hobby),
    CONSTRAINT profile_hobby_profile_fk FOREIGN KEY (id_profile)
        REFERENCES profile(id) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT profile_hobby_hobby_fk FOREIGN KEY (id_hobby)
        REFERENCES hobby(id) ON UPDATE CASCADE ON DELETE CASCADE
);

CREATE INDEX profile_hobby_profile_idx ON profile_hobby (id_profile);
CREATE INDEX profile_hobby_hobby_idx ON profile_hobby (id_hobby);

INSERT INTO hobby (name)
SELECT DISTINCT name
FROM hobby_old
WHERE name IS NOT NULL;

INSERT INTO profile_hobby (id_profile, id_hobby)
SELECT h_old.id_profile, h_new.id
FROM hobby_old h_old
JOIN hobby h_new ON h_new.name = h_old.name
WHERE h_old.id_profile IS NOT NULL;

-- Optional seed (keeps CSS class mapping stable).
INSERT INTO hobby (name) VALUES
    ('Cycling'),
    ('Handball'),
    ('Football'),
    ('Basketball'),
    ('Bowling'),
    ('Boxing'),
    ('Volleyball'),
    ('Baseball'),
    ('Skating'),
    ('Skiing'),
    ('Table tennis'),
    ('Tennis'),
    ('Weightlifting'),
    ('Automobiles'),
    ('Book reading'),
    ('Cricket'),
    ('Photo'),
    ('Shopping'),
    ('Cooking'),
    ('Codding'),
    ('Animals'),
    ('Traveling'),
    ('Movie'),
    ('Painting'),
    ('Darts'),
    ('Fishing'),
    ('Kayak slalom'),
    ('Games of chance'),
    ('Ice hockey'),
    ('Roller skating'),
    ('Swimming'),
    ('Diving'),
    ('Golf'),
    ('Shooting'),
    ('Rowing'),
    ('Camping'),
    ('Archery'),
    ('Pubs'),
    ('Music'),
    ('Computer games'),
    ('Authorship'),
    ('Singing'),
    ('Foreign lang'),
    ('Billiards'),
    ('Skateboarding'),
    ('Collecting'),
    ('Badminton'),
    ('Disco')
ON CONFLICT (name) DO NOTHING;

-- Optional: DROP TABLE hobby_old;

COMMIT;
